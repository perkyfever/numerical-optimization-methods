#include <algorithm>
#include <iostream>
#include "analytical.h"
#include "constants.h"
#include "time_marshalling.h"

double payoff(double si) {
    return std::max<double>(si - (double)K, 0);
}

int main() {
    std::array<double, N + 1> c_init = {};
    for (int i = 0; i <= N; ++i) {
        c_init[i] = payoff((double)i * S_max / (double)N);
    }

    std::array<double, N + 1> c_res = {};
    go<N + 1>(c_init, c_res);

    size_t ind = std::min((size_t)(N * K * 0.9 / S_max), N);
    size_t ind_next = std::min((size_t)(ind + 1), N);
    double c_max = c_res[ind] + (c_res[ind_next] - c_res[ind]) * 0.5;

    std::cout << "Analytic: C(S_max, T) = " << option_price(K * 0.9, 1) << '\n';
    std::cout << "Numerical: C(S_max, T) = " << c_max << '\n';

    //    for (int i = 0; i <= N; i++) {
    //        std::cout << "C(" << (double)i * S_max / (double)N << ", T) = " << c_res[i];
    //        std::cout << std::endl;
    //    }

    return 0;
}

/*
Analytic: C(S_max, T) = 10.9207
Numerical: C(S_max, T) = 8.79225
*/

/*
C(0, T) = 0
C(0.612971, T) = 0
C(1.22594, T) = 0
C(1.83891, T) = 0
C(2.45188, T) = 0
C(3.06485, T) = 0
C(3.67783, T) = 0
C(4.2908, T) = 0
C(4.90377, T) = 0
C(5.51674, T) = 0
C(6.12971, T) = 0
C(6.74268, T) = 0
C(7.35565, T) = 0
C(7.96862, T) = 0
C(8.58159, T) = 0
C(9.19456, T) = 0
C(9.80753, T) = 0
C(10.4205, T) = 0
C(11.0335, T) = 0
C(11.6464, T) = 0
C(12.2594, T) = 0
C(12.8724, T) = 1.15898e-319
C(13.4854, T) = 7.63794e-316
C(14.0983, T) = 4.55617e-312
C(14.7113, T) = 2.46898e-308
C(15.3243, T) = 1.21998e-304
C(15.9372, T) = 5.51554e-301
C(16.5502, T) = 2.28873e-297
C(17.1632, T) = 8.74249e-294
C(17.7762, T) = 3.08232e-290
C(18.3891, T) = 1.00556e-286
C(19.0021, T) = 3.04255e-283
C(19.6151, T) = 8.55668e-280
C(20.228, T) = 2.24126e-276
C(20.841, T) = 5.47797e-273
C(21.454, T) = 1.25159e-269
C(22.067, T) = 2.67761e-266
C(22.6799, T) = 5.37224e-263
C(23.2929, T) = 1.01235e-259
C(23.9059, T) = 1.79426e-256
C(24.5188, T) = 2.99494e-253
C(25.1318, T) = 4.71394e-250
C(25.7448, T) = 7.0047e-247
C(26.3577, T) = 9.83767e-244
C(26.9707, T) = 1.30724e-240
C(27.5837, T) = 1.6452e-237
C(28.1967, T) = 1.96291e-234
C(28.8096, T) = 2.22229e-231
C(29.4226, T) = 2.38945e-228
C(30.0356, T) = 2.44204e-225
C(30.6485, T) = 2.37418e-222
C(31.2615, T) = 2.19738e-219
C(31.8745, T) = 1.93751e-216
C(32.4875, T) = 1.62866e-213
C(33.1004, T) = 1.30602e-210
C(33.7134, T) = 9.99716e-208
C(34.3264, T) = 7.30926e-205
C(34.9393, T) = 5.1073e-202
C(35.5523, T) = 3.41247e-199
C(36.1653, T) = 2.18141e-196
C(36.7783, T) = 1.3348e-193
C(37.3912, T) = 7.8219e-191
C(38.0042, T) = 4.39168e-188
C(38.6172, T) = 2.36354e-185
C(39.2301, T) = 1.21982e-182
C(39.8431, T) = 6.03948e-180
C(40.4561, T) = 2.86978e-177
C(41.069, T) = 1.30919e-174
C(41.682, T) = 5.73607e-172
C(42.295, T) = 2.41454e-169
C(42.908, T) = 9.76789e-167
C(43.5209, T) = 3.79883e-164
C(44.1339, T) = 1.42072e-161
C(44.7469, T) = 5.11094e-159
C(45.3598, T) = 1.76905e-156
C(45.9728, T) = 5.89307e-154
C(46.5858, T) = 1.88976e-151
C(47.1988, T) = 5.83495e-149
C(47.8117, T) = 1.73511e-146
C(48.4247, T) = 4.9701e-144
C(49.0377, T) = 1.37163e-141
C(49.6506, T) = 3.6477e-139
C(50.2636, T) = 9.3495e-137
C(50.8766, T) = 2.31001e-134
C(51.4896, T) = 5.50251e-132
C(52.1025, T) = 1.26383e-129
C(52.7155, T) = 2.79933e-127
C(53.3285, T) = 5.98008e-125
C(53.9414, T) = 1.23224e-122
C(54.5544, T) = 2.44938e-120
C(55.1674, T) = 4.69713e-118
C(55.7803, T) = 8.6907e-116
C(56.3933, T) = 1.5515e-113
C(57.0063, T) = 2.67268e-111
C(57.6193, T) = 4.44282e-109
C(58.2322, T) = 7.12695e-107
C(58.8452, T) = 1.10329e-104
C(59.4582, T) = 1.64826e-102
C(60.0711, T) = 2.37635e-100
C(60.6841, T) = 3.30627e-98
C(61.2971, T) = 4.43919e-96
C(61.9101, T) = 5.75165e-94
C(62.523, T) = 7.19093e-92
C(63.136, T) = 8.67478e-90
C(63.749, T) = 1.00968e-87
C(64.3619, T) = 1.13378e-85
C(64.9749, T) = 1.22815e-83
C(65.5879, T) = 1.28323e-81
C(66.2009, T) = 1.29314e-79
C(66.8138, T) = 1.25664e-77
C(67.4268, T) = 1.17744e-75
C(68.0398, T) = 1.06356e-73
C(68.6527, T) = 9.25981e-72
C(69.2657, T) = 7.76924e-70
C(69.8787, T) = 6.2806e-68
C(70.4916, T) = 4.89071e-66
C(71.1046, T) = 3.66764e-64
C(71.7176, T) = 2.64808e-62
C(72.3306, T) = 1.84029e-60
C(72.9435, T) = 1.2306e-58
C(73.5565, T) = 7.91563e-57
C(74.1695, T) = 4.896e-55
C(74.7824, T) = 2.91087e-53
C(75.3954, T) = 1.66287e-51
C(76.0084, T) = 9.12357e-50
C(76.6214, T) = 4.80556e-48
C(77.2343, T) = 2.42876e-46
C(77.8473, T) = 1.17723e-44
C(78.4603, T) = 5.46937e-43
C(79.0732, T) = 2.43417e-41
C(79.6862, T) = 1.03712e-39
C(80.2992, T) = 4.22744e-38
C(80.9122, T) = 1.64732e-36
C(81.5251, T) = 6.13187e-35
C(82.1381, T) = 2.17851e-33
C(82.7511, T) = 7.38052e-32
C(83.364, T) = 2.38207e-30
C(83.977, T) = 7.31659e-29
C(84.59, T) = 2.1363e-27
C(85.2029, T) = 5.92222e-26
C(85.8159, T) = 1.5567e-24
C(86.4289, T) = 3.87436e-23
C(87.0419, T) = 9.11583e-22
C(87.6548, T) = 2.0242e-20
C(88.2678, T) = 4.23413e-19
C(88.8808, T) = 8.32612e-18
C(89.4937, T) = 1.53572e-16
C(90.1067, T) = 2.65031e-15
C(90.7197, T) = 4.2677e-14
C(91.3327, T) = 6.3925e-13
C(91.9456, T) = 8.87626e-12
C(92.5586, T) = 1.13812e-10
C(93.1716, T) = 1.34162e-09
C(93.7845, T) = 1.4467e-08
C(94.3975, T) = 1.41883e-07
C(95.0105, T) = 1.25717e-06
C(95.6235, T) = 9.98599e-06
C(96.2364, T) = 7.04625e-05
C(96.8494, T) = 0.000436929
C(97.4624, T) = 0.00235066
C(98.0753, T) = 0.0108075
C(98.6883, T) = 0.041725
C(99.3013, T) = 0.132706
C(99.9142, T) = 0.341692
C(100.527, T) = 0.707568
C(101.14, T) = 1.20304
C(101.753, T) = 1.77158
C(102.366, T) = 2.37078
C(102.979, T) = 2.98015
C(103.592, T) = 3.5923
C(104.205, T) = 4.20511
C(104.818, T) = 4.81806
C(105.431, T) = 5.43102
C(106.044, T) = 6.04399
C(106.657, T) = 6.65696
C(107.27, T) = 7.26994
C(107.883, T) = 7.88291
C(108.496, T) = 8.49588
C(109.109, T) = 9.10885
C(109.722, T) = 9.72182
C(110.335, T) = 10.3348
C(110.948, T) = 10.9478
C(111.561, T) = 11.5607
C(112.174, T) = 12.1737
C(112.787, T) = 12.7867
C(113.4, T) = 13.3996
C(114.013, T) = 14.0126
C(114.626, T) = 14.6256
C(115.239, T) = 15.2386
C(115.851, T) = 15.8515
C(116.464, T) = 16.4645
C(117.077, T) = 17.0775
C(117.69, T) = 17.6904
C(118.303, T) = 18.3034
C(118.916, T) = 18.9164
C(119.529, T) = 19.5294
C(120.142, T) = 20.1423
C(120.755, T) = 20.7553
C(121.368, T) = 21.3683
C(121.981, T) = 21.9812
C(122.594, T) = 22.5942
C(123.207, T) = 23.2072
C(123.82, T) = 23.8202
C(124.433, T) = 24.4331
C(125.046, T) = 25.0461
C(125.659, T) = 25.6591
C(126.272, T) = 26.272
C(126.885, T) = 26.885
C(127.498, T) = 27.498
C(128.111, T) = 28.111
C(128.724, T) = 28.7239
C(129.337, T) = 29.3369
C(129.95, T) = 29.9499
C(130.563, T) = 30.5628
C(131.176, T) = 31.1758
C(131.789, T) = 31.7888
C(132.402, T) = 32.4017
C(133.015, T) = 33.0147
C(133.628, T) = 33.6277
C(134.241, T) = 34.2407
C(134.854, T) = 34.8536
C(135.467, T) = 35.4666
C(136.08, T) = 36.0796
C(136.692, T) = 36.6925
C(137.305, T) = 37.3055
C(137.918, T) = 37.9185
C(138.531, T) = 38.5315
C(139.144, T) = 39.1444
C(139.757, T) = 39.7574
C(140.37, T) = 40.3704
C(140.983, T) = 40.9833
C(141.596, T) = 41.5963
C(142.209, T) = 42.2093
C(142.822, T) = 42.8223
C(143.435, T) = 43.4352
C(144.048, T) = 44.0482
C(144.661, T) = 44.6612
C(145.274, T) = 45.2741
C(145.887, T) = 45.8871
C(146.5, T) = 46.5001
C(147.113, T) = 47.1131
C(147.726, T) = 47.726
C(148.339, T) = 48.339
C(148.952, T) = 48.952
C(149.565, T) = 49.5649
C(150.178, T) = 50.1779
C(150.791, T) = 50.7909
C(151.404, T) = 51.4039
C(152.017, T) = 52.0168
C(152.63, T) = 52.6298
C(153.243, T) = 53.2428
C(153.856, T) = 53.8557
C(154.469, T) = 54.4687
C(155.082, T) = 55.0817
C(155.695, T) = 55.6946
C(156.308, T) = 56.3076
C(156.921, T) = 56.9206
C(157.534, T) = 57.5336
C(158.146, T) = 58.1465
C(158.759, T) = 58.7595
C(159.372, T) = 59.3725
C(159.985, T) = 59.9854
C(160.598, T) = 60.5984
C(161.211, T) = 61.2114
C(161.824, T) = 61.8244
C(162.437, T) = 62.4373
C(163.05, T) = 63.0503
C(163.663, T) = 63.6633
C(164.276, T) = 64.2762
C(164.889, T) = 64.8892
C(165.502, T) = 65.5022
C(166.115, T) = 66.1152
C(166.728, T) = 66.7281
C(167.341, T) = 67.3411
C(167.954, T) = 67.9541
C(168.567, T) = 68.567
C(169.18, T) = 69.18
C(169.793, T) = 69.793
C(170.406, T) = 70.406
C(171.019, T) = 71.0189
C(171.632, T) = 71.6319
C(172.245, T) = 72.2449
C(172.858, T) = 72.8578
C(173.471, T) = 73.4708
C(174.084, T) = 74.0838
C(174.697, T) = 74.6968
C(175.31, T) = 75.3097
C(175.923, T) = 75.9227
C(176.536, T) = 76.5357
C(177.149, T) = 77.1486
C(177.762, T) = 77.7616
C(178.375, T) = 78.3746
C(178.987, T) = 78.9876
C(179.6, T) = 79.6005
C(180.213, T) = 80.2135
C(180.826, T) = 80.8265
C(181.439, T) = 81.4394
C(182.052, T) = 82.0524
C(182.665, T) = 82.6654
C(183.278, T) = 83.2783
C(183.891, T) = 83.8913
C(184.504, T) = 84.5043
C(185.117, T) = 85.1173
C(185.73, T) = 85.7302
C(186.343, T) = 86.3432
C(186.956, T) = 86.9562
C(187.569, T) = 87.5691
C(188.182, T) = 88.1821
C(188.795, T) = 88.7951
C(189.408, T) = 89.4081
C(190.021, T) = 90.021
C(190.634, T) = 90.634
C(191.247, T) = 91.247
C(191.86, T) = 91.8599
C(192.473, T) = 92.4729
C(193.086, T) = 93.0859
C(193.699, T) = 93.6989
C(194.312, T) = 94.3118
C(194.925, T) = 94.9248
C(195.538, T) = 95.5378
C(196.151, T) = 96.1507
C(196.764, T) = 96.7637
C(197.377, T) = 97.3767
C(197.99, T) = 97.9897
C(198.603, T) = 98.6026
C(199.216, T) = 99.2156
C(199.828, T) = 99.8286
C(200.441, T) = 100.442
C(201.054, T) = 101.055
C(201.667, T) = 101.667
C(202.28, T) = 102.28
C(202.893, T) = 102.893
C(203.506, T) = 103.506
C(204.119, T) = 104.119
C(204.732, T) = 104.732
C(205.345, T) = 105.345
C(205.958, T) = 105.958
C(206.571, T) = 106.571
C(207.184, T) = 107.184
C(207.797, T) = 107.797
C(208.41, T) = 108.41
C(209.023, T) = 109.023
C(209.636, T) = 109.636
C(210.249, T) = 110.249
C(210.862, T) = 110.862
C(211.475, T) = 111.475
C(212.088, T) = 112.088
C(212.701, T) = 112.701
C(213.314, T) = 113.314
C(213.927, T) = 113.927
C(214.54, T) = 114.54
C(215.153, T) = 115.153
C(215.766, T) = 115.766
C(216.379, T) = 116.379
C(216.992, T) = 116.992
C(217.605, T) = 117.605
C(218.218, T) = 118.218
C(218.831, T) = 118.831
C(219.444, T) = 119.444
C(220.057, T) = 120.057
C(220.67, T) = 120.67
C(221.282, T) = 121.283
C(221.895, T) = 121.896
C(222.508, T) = 122.508
C(223.121, T) = 123.121
C(223.734, T) = 123.734
C(224.347, T) = 124.347
C(224.96, T) = 124.96
C(225.573, T) = 125.573
C(226.186, T) = 126.186
C(226.799, T) = 126.799
C(227.412, T) = 127.412
C(228.025, T) = 128.025
C(228.638, T) = 128.638
C(229.251, T) = 129.251
C(229.864, T) = 129.864
C(230.477, T) = 130.477
C(231.09, T) = 131.09
C(231.703, T) = 131.703
C(232.316, T) = 132.316
C(232.929, T) = 132.929
C(233.542, T) = 133.542
C(234.155, T) = 134.155
C(234.768, T) = 134.768
C(235.381, T) = 135.381
C(235.994, T) = 135.994
C(236.607, T) = 136.607
C(237.22, T) = 137.22
C(237.833, T) = 137.833
C(238.446, T) = 138.446
C(239.059, T) = 139.059
C(239.672, T) = 139.672
C(240.285, T) = 140.285
C(240.898, T) = 140.898
C(241.511, T) = 141.511
C(242.123, T) = 142.124
C(242.736, T) = 142.737
C(243.349, T) = 143.35
C(243.962, T) = 143.962
C(244.575, T) = 144.575
C(245.188, T) = 145.188
C(245.801, T) = 145.801
C(246.414, T) = 146.414
C(247.027, T) = 147.027
C(247.64, T) = 147.64
C(248.253, T) = 148.253
C(248.866, T) = 148.866
C(249.479, T) = 149.479
C(250.092, T) = 150.092
C(250.705, T) = 150.705
C(251.318, T) = 151.318
C(251.931, T) = 151.931
C(252.544, T) = 152.544
C(253.157, T) = 153.157
C(253.77, T) = 153.77
C(254.383, T) = 154.383
C(254.996, T) = 154.996
C(255.609, T) = 155.609
C(256.222, T) = 156.222
C(256.835, T) = 156.835
C(257.448, T) = 157.448
C(258.061, T) = 158.061
C(258.674, T) = 158.674
C(259.287, T) = 159.287
C(259.9, T) = 159.9
C(260.513, T) = 160.513
C(261.126, T) = 161.126
C(261.739, T) = 161.739
C(262.352, T) = 162.352
C(262.964, T) = 162.965
C(263.577, T) = 163.578
C(264.19, T) = 164.191
C(264.803, T) = 164.803
C(265.416, T) = 165.416
C(266.029, T) = 166.029
C(266.642, T) = 166.642
C(267.255, T) = 167.255
C(267.868, T) = 167.868
C(268.481, T) = 168.481
C(269.094, T) = 169.094
C(269.707, T) = 169.707
C(270.32, T) = 170.32
C(270.933, T) = 170.933
C(271.546, T) = 171.546
C(272.159, T) = 172.159
C(272.772, T) = 172.772
C(273.385, T) = 173.385
C(273.998, T) = 173.998
C(274.611, T) = 174.611
C(275.224, T) = 175.224
C(275.837, T) = 175.837
C(276.45, T) = 176.45
C(277.063, T) = 177.063
C(277.676, T) = 177.676
C(278.289, T) = 178.289
C(278.902, T) = 178.902
C(279.515, T) = 179.515
C(280.128, T) = 180.128
C(280.741, T) = 180.741
C(281.354, T) = 181.354
C(281.967, T) = 181.967
C(282.58, T) = 182.58
C(283.193, T) = 183.193
C(283.805, T) = 183.806
C(284.418, T) = 184.419
C(285.031, T) = 185.032
C(285.644, T) = 185.645
C(286.257, T) = 186.257
C(286.87, T) = 186.87
C(287.483, T) = 187.483
C(288.096, T) = 188.096
C(288.709, T) = 188.709
C(289.322, T) = 189.322
C(289.935, T) = 189.935
C(290.548, T) = 190.548
C(291.161, T) = 191.161
C(291.774, T) = 191.774
C(292.387, T) = 192.387
C(293, T) = 193
C(293.613, T) = 193.613
C(294.226, T) = 194.226
C(294.839, T) = 194.839
C(295.452, T) = 195.451
C(296.065, T) = 196.063
C(296.678, T) = 196.673
C(297.291, T) = 197.28
C(297.904, T) = 197.882
C(298.517, T) = 198.472
C(299.13, T) = 199.041
C(299.743, T) = 199.572
C(300.356, T) = 200.039
C(300.969, T) = 200.401
C(301.582, T) = 200.595
C(302.195, T) = 200.531
C(302.808, T) = 200.091
C(303.421, T) = 199.117
C(304.034, T) = 197.418
C(304.647, T) = 194.771
C(305.259, T) = 190.93
C(305.872, T) = 185.64
C(306.485, T) = 178.661
*/
